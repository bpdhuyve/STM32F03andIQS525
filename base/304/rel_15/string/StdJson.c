//================================================================================================//
// M O D U L E   H E A D E R
//------------------------------------------------------------------------------------------------//
// module to compose JSON strings
//
// Copyright (c), PsiControl Mechatronics NV, All rights reserved.
//================================================================================================//
#define STDJSON_C
//================================================================================================//



//================================================================================================//
// V E R I F Y    C O N F I G U R A T I O N
//------------------------------------------------------------------------------------------------//
#include "AppConfig.h"
//------------------------------------------------------------------------------------------------//
// @brief  Defines the log level of the module
#ifndef STDJSON_LOG_LEVEL
    #define CORELOG_LEVEL               LOG_LEVEL_DEFAULT
#else
    #define CORELOG_LEVEL               STDJSON_LOG_LEVEL
#endif
//------------------------------------------------------------------------------------------------//
#ifndef JSON_BUFFER_SIZE
    #error "JSON_BUFFER_SIZE not defined in AppConfig"
#endif
//================================================================================================//


//================================================================================================//
// I N C L U D E S
//------------------------------------------------------------------------------------------------//
#include "Core.h"

// DRV

// STD
#include "string/StdJson.h"
//================================================================================================//



//================================================================================================//
// L O C A L   D E F I N I T I O N S   A N D   M A C R O S
//------------------------------------------------------------------------------------------------//
//================================================================================================//



//================================================================================================//
// L O C A L   T Y P E D E F S
//------------------------------------------------------------------------------------------------//
//================================================================================================//



//================================================================================================//
// L O C A L   F U N C T I O N   P R O T O T Y P E S
//------------------------------------------------------------------------------------------------//
#if (TERM_LEVEL > TERM_LEVEL_NONE)
#endif
//================================================================================================//



//================================================================================================//
// L O C A L   V A R I A B L E S
//------------------------------------------------------------------------------------------------//
MODULE_DECLARE();

static STRING                   json_buffer_ptr;
static U32                      json_buffer_len;
static U8                       json_bracket_count;
static BOOL                     json_add_allowed;
static BOOL                     json_first_key;
//================================================================================================//



//================================================================================================//
// E X P O R T E D   V A R I A B L E S
//------------------------------------------------------------------------------------------------//
const STRING true_false_string[2]                = {"false", "true"};
//================================================================================================//



//================================================================================================//
// L O C A L   F U N C T I O N S
//------------------------------------------------------------------------------------------------//
//================================================================================================//



//================================================================================================//
// C O M M A N D   F U N C T I O N S
//------------------------------------------------------------------------------------------------//
#if (TERM_LEVEL > TERM_LEVEL_NONE)
#endif
//================================================================================================//



//================================================================================================//
// E X P O R T E D   F U N C T I O N S
//------------------------------------------------------------------------------------------------//
void StdJson_Init(void)
{
    MODULE_INIT_ONCE();
    
    json_buffer_ptr = (STRING)CoreBuffer_CreateStaticU8(JSON_BUFFER_SIZE, "json");
    
    MODULE_INIT_DONE();
    
    json_buffer_len = 0;
    json_bracket_count = 0;
    json_add_allowed = TRUE; 
}
//------------------------------------------------------------------------------------------------//
void StdJson_GetBuffer(STRING* json_string_ptr, U16* json_len_ptr)
{
    *json_string_ptr = json_buffer_ptr;
    *json_len_ptr    = json_buffer_len;
}
//------------------------------------------------------------------------------------------------//
BOOL StdJson_Open(void)
{
    if(json_add_allowed && ((json_buffer_len + json_bracket_count + 2) < JSON_BUFFER_SIZE))
    {
        json_buffer_ptr[json_buffer_len] = '{';
        json_buffer_len++;
        json_bracket_count++;
        json_first_key = TRUE;
        return TRUE;
    }
    return FALSE;
}
//------------------------------------------------------------------------------------------------//
void StdJson_Close(void)
{
    if(json_bracket_count > 0)
    {
        json_buffer_ptr[json_buffer_len] = '}';
        json_buffer_len++;
        json_bracket_count--;
        json_first_key = FALSE;
    }
}
//------------------------------------------------------------------------------------------------//
void StdJson_AddComma(void)
{
    if(json_first_key)
    {
        json_first_key = FALSE;
        return;
    }
    if(json_add_allowed)
    {
        json_buffer_ptr[json_buffer_len] = ',';
        json_buffer_len++;
    }
}
//------------------------------------------------------------------------------------------------//
STRING StdJson_GetBufferPosition(void)
{
    return (STRING)(json_buffer_ptr + json_buffer_len);
}
//------------------------------------------------------------------------------------------------//
U32 StdJson_GetBufferSpace(void)
{
    return (U32)(JSON_BUFFER_SIZE - json_buffer_len);
}
//------------------------------------------------------------------------------------------------//
void StdJson_AddCheck(U32 add_len)
{
    if(json_add_allowed)
    {
        if((json_buffer_len + json_bracket_count + add_len) < JSON_BUFFER_SIZE)
        {
            json_buffer_len += add_len;
        }
        else
        {
            if(json_buffer_ptr[json_buffer_len - 1] == ',')
            {
                json_buffer_len--;
            }
            json_add_allowed = FALSE;
            LOG_TRM("JSON add failed");
        }
    }
}
//================================================================================================//
