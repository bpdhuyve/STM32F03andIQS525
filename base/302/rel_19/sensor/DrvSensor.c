//================================================================================================//
// M O D U L E   H E A D E R
//------------------------------------------------------------------------------------------------//
// Implementation of the common part of the sensor driver
//
// Copyright (c), PsiControl Mechatronics NV, All rights reserved.
//================================================================================================//
#define SENSOR__DRVSENSOR_C
//================================================================================================//



//================================================================================================//
// V E R I F Y    C O N F I G U R A T I O N
//------------------------------------------------------------------------------------------------//
#include "AppConfig.h"
//------------------------------------------------------------------------------------------------//
// @brief  Defines the log level of the module
#ifndef SENSOR__DRVSENSOR_LOG_LEVEL
	#define CORELOG_LEVEL               LOG_LEVEL_NONE
#else
	#define CORELOG_LEVEL               SENSOR__DRVSENSOR_LOG_LEVEL
#endif
//================================================================================================//



//================================================================================================//
// I N C L U D E S
//------------------------------------------------------------------------------------------------//
#include "Core.h"

//DRV include section
#include "sensor\DrvSensor.h"
//================================================================================================//



//================================================================================================//
// L O C A L   D E F I N I T I O N S   A N D   M A C R O S
//------------------------------------------------------------------------------------------------//
#define RH_COEF_MIN_TEMP        (S16)(-300)   //-30°C
#define RH_COEF_MAX_TEMP        (S16)800      // 80°C
//================================================================================================//



//================================================================================================//
// L O C A L   T Y P E D E F S
//------------------------------------------------------------------------------------------------//
//================================================================================================//



//================================================================================================//
// L O C A L   F U N C T I O N   P R O T O T Y P E S
//------------------------------------------------------------------------------------------------//
static U16 Sensor_GetRhCoef(S16 temperature);
//================================================================================================//



//================================================================================================//
// L O C A L   V A R I A B L E S
//------------------------------------------------------------------------------------------------//
static const U16            rh_coef_lookup[111] = 
                                {70,	77,		84,		92,		101,	111,	121,	133,	145,	158,
                                172,	188,	204,	222,	241,	262,	285,	309,	335,	362,
                                392,	424,	459,	495,	535,	577,	622,	670,	722,	777,
                                835,	898,	965,	1036,	1111,	1191,	1277,	1368,	1464,	1567,
                                1676,	1791,	1913,	2043,	2180,	2326,	2480,	2642,	2814,	2996,
                                3188,	3391,	3605,	3830,	4068,	4319,	4583,	4861,	5154,	5462,
                                5787,	6127,	6485,	6862,	7257,	7671,	8107,	8563,	9042,	9544,
                                10070,	10620,	11197,	11801,	12432,	13093,	13784,	14506,	15261,	16050,
                                16873,	17733,	18630,	19566,	20542,	21560,	22621,	23726,	24878,	26077,
                                27326,	28626,	29978,	31385,	32849,	34370,	35951,	37594,	39300,	41073,
                                42913,	44824,	46806,	48863,	50996,	53208,	55501,	57878,	60341,	62893, 65535};
//================================================================================================//



//================================================================================================//
// E X P O R T E D   V A R I A B L E S
//------------------------------------------------------------------------------------------------//
//================================================================================================//



//================================================================================================//
// L O C A L   F U N C T I O N S
//------------------------------------------------------------------------------------------------//
static U16 Sensor_GetRhCoef(S16 temperature)
{
    U16 index;
    U16 fraction;
    U32 temp;
    
    if(temperature >= RH_COEF_MAX_TEMP)
    {
        return 0xFFFF;
    }
    else if(temperature <= RH_COEF_MIN_TEMP)
    {
        return rh_coef_lookup[0];
    }
    else
    {
        temperature -= RH_COEF_MIN_TEMP;
        
        index = (U8)(temperature / 10);
        fraction = temperature - (index * 10);
        
        temp = (U32)(10 - fraction) * (U32)rh_coef_lookup[index];
        temp += (U32)(fraction) * (U32)rh_coef_lookup[index + 1];
        
        return (U16)(temp / 10);
    }
}
//================================================================================================//


//================================================================================================//
// E X P O R T E D   F U N C T I O N S
//------------------------------------------------------------------------------------------------//
void DrvSensor_Init(void)
{
}
//------------------------------------------------------------------------------------------------//
BOOL DrvSensor_DetectPresence(SENSOR_HNDL sensor_hndl)
{
    if((sensor_hndl != NULL) && (sensor_hndl->hook_list_ptr != NULL) && (sensor_hndl->hook_list_ptr->is_present_hook != NULL))
    {
        return sensor_hndl->hook_list_ptr->is_present_hook(sensor_hndl->sensor_id);
    }
    LOG_WRN("SENSOR is present function is NULL");
    return FALSE;
}
//------------------------------------------------------------------------------------------------//
BOOL DrvSensor_StartRead(SENSOR_HNDL sensor_hndl, SENSOR_TYPE sensor_type, BOOL wait_to_complete)
{
    if((sensor_hndl != NULL) && (sensor_hndl->hook_list_ptr != NULL) && (sensor_hndl->hook_list_ptr->read_sensor_hook != NULL))
    {
        return sensor_hndl->hook_list_ptr->read_sensor_hook(sensor_hndl->sensor_id, sensor_type, wait_to_complete);
    }
    LOG_WRN("SENSOR read sensor function is NULL");
    return FALSE;
}
//------------------------------------------------------------------------------------------------//
BOOL DrvSensor_GetValue(SENSOR_HNDL sensor_hndl, SENSOR_TYPE sensor_type, U16* data_ptr)
{
    if((sensor_hndl != NULL) && (sensor_hndl->hook_list_ptr != NULL) && (sensor_hndl->hook_list_ptr->get_value_hook != NULL))
    {
        return sensor_hndl->hook_list_ptr->get_value_hook(sensor_hndl->sensor_id, sensor_type, data_ptr);
    }
    LOG_WRN("SENSOR get value function is NULL");
    return FALSE;
}
//------------------------------------------------------------------------------------------------//
BOOL DrvSensor_Reset(SENSOR_HNDL sensor_hndl)
{
	if((sensor_hndl != NULL) && (sensor_hndl->hook_list_ptr != NULL) && (sensor_hndl->hook_list_ptr->reset_hook != NULL))
    {
        return sensor_hndl->hook_list_ptr->reset_hook(sensor_hndl->sensor_id);
    }
    LOG_WRN("SENSOR reset function is NULL");
    return FALSE;
}
//------------------------------------------------------------------------------------------------//
U16 DrvSensor_CompensateRhValueForTemperature(U16 rh_value, S16 temp_value, S16 temp_offset)
{
    return (U16)((U32)rh_value * (U32)Sensor_GetRhCoef(temp_value) / (U32)Sensor_GetRhCoef(temp_value + temp_offset));
}
//================================================================================================//
